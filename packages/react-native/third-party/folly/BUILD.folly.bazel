load("@rules_foreign_cc//foreign_cc:defs.bzl", "cmake")

filegroup(
    name = "srcs",
    srcs = glob([
        "folly/String.cpp",
        "folly/Conv.cpp",
        "folly/Demangle.cpp",
        "folly/FileUtil.cpp",
        "folly/Format.cpp",
        "folly/lang/SafeAssert.cpp",
        "folly/lang/ToAscii.cpp",
        "folly/ScopeGuard.cpp",
        "folly/Unicode.cpp",
        "folly/dynamic.cpp",
        "folly/json.cpp",
        "folly/json_pointer.cpp",
        "folly/container/detail/F14Table.cpp",
        "folly/detail/Demangle.cpp",
        "folly/detail/FileUtilDetail.cpp",
        "folly/detail/SplitStringSimd.cpp",
        "folly/detail/UniqueInstance.cpp",
        "folly/hash/SpookyHashV2.cpp",
        "folly/lang/Assume.cpp",
        "folly/lang/CString.cpp",
        "folly/lang/Exception.cpp",
        "folly/memory/detail/MallocImpl.cpp",
        "folly/net/NetOps.cpp",
        "folly/portability/SysUio.cpp",
        "folly/synchronization/RelaxedAtomic.h",
        "folly/synchronization/SanitizeThread.h",
        "folly/synchronization/SanitizeThread.cpp",
        "folly/system/AtFork.cpp",
        "folly/system/ThreadId.cpp",
        "folly/*.h",
        "folly/container/*.h",
        "folly/container/detail/*.h",
        "folly/detail/*.h",
        "folly/functional/*.h",
        "folly/hash/*.h",
        "folly/lang/*.h",
        "folly/memory/*.h",
        "folly/memory/detail/*.h",
        "folly/net/*.h",
        "folly/net/detail/*.h",
        "folly/portability/*.h",
        "folly/system/*.h"
    ]),
)

filegroup(
    name = "hdrs",
    srcs = glob([
        "folly/*.h",
        "folly/container/*.h",
        "folly/container/detail/*.h",
        "folly/detail/*.h",
        "folly/functional/*.h",
        "folly/hash/*.h",
        "folly/lang/*.h",
        "folly/memory/*.h",
        "folly/memory/detail/*.h",
        "folly/net/*.h",
        "folly/net/detail/*.h",
        "folly/portability/*.h",
        "folly/system/*.h",
    ]),
)

cc_library(
    name = "folly",
    srcs = [":srcs"],
    hdrs = [":hdrs"],
    defines = [
        "FOLLY_NO_CONFIG",
        "FOLLY_MOBILE=1", 
        "FOLLY_USE_LIBCPP=1", 
        "FOLLY_CFG_NO_COROUTINES=1", 
        "FOLLY_HAVE_CLOCK_GETTIME=1",
    ],
    copts = [
        "-Wno-comma",
        "-Wno-shorten-64-to-32",
        "-std=c++17",
        "-fexceptions",
        "-frtti",
    ],
    deps = [
        "@glog",
        "@fmt",
        "@boost.preprocessor",
        "@boost.utility",
        "@boost.algorithm",
        "@double-conversion",        
    ],
    includes = ["."],
    visibility = ["//visibility:public"],
)